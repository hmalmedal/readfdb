#' Read CSV file generated by FDB
#'
#' Read a CSV file generated by Ferjedatabanken.
#'
#' @param file Path to file.
#' @param total Extract total values.
#' @param unparsed Return unparsed data frame.
#'
#' @return A data frame.
#' @export
read_fdb_csv <- function(file, total = FALSE, unparsed = FALSE) {
  checkmate::assertFile(file, access = "r")
  checkmate::assertFlag(total)
  checkmate::assertFlag(unparsed)

  csv_pages <- readr::read_file(file) %>%
    iconv("latin1", "utf8") %>%
    strsplit("\n,*\\d{1,2}-\\w{3}-\\d{4},*Side \\d+,* av \\d+,*\n") %>%
    getElement(1)

  df <- lapply(csv_pages, parse_csv_page) %>%
    dplyr::bind_rows()

  if (unparsed) return(df)

  checkmate::assertDataFrame(df, min.cols = 14)

  type <- unique(df$type)
  subtype <- unique(df$subtype)

  if (identical(type, "Variasjonskurver")) {
    if (identical(subtype, "D\u00f8gnvariasjon")) {
      if (total) warning("Parameter \"total\" not implemented.")
      df <- parse_variasjonskurver_dognvariasjon(df)
    } else if (identical(subtype, "Ukesvariasjon")) {
      if (total) warning("Parameter \"total\" not implemented.")
      df <- parse_variasjonskurver_ukesvariasjon(df)
    } else if (identical(subtype, "\u00c5rsvariasjon")) {
      df <- parse_variasjonskurver_aarsvariasjon(df, total)
    } else {
      stop("Unknown error.")
    }
  } else if (identical(type, "Trafikkindeks") ||
             identical(type, "Begrenset trafikkindeks")) {
    if (identical(subtype, "\u00c5rsindeks")) {
      df <- parse_trafikkindeks_aarsindeks(df, total)
    } else if (identical(subtype, "Kvartalsindeks")) {
      df <- parse_trafikkindeks_kvartalsindeks(df, total)
    } else if (identical(subtype, "Siste 12 m\u00e5neder")) {
      df <- parse_trafikkindeks_siste_12_maaneder(df, total)
    } else {
      stop("Unknown error.")
    }
  } else if (identical(type, "Trafikkverdier")) {
    if (total) warning("Parameter \"total\" ignored.")
    df <- parse_trafikkverdier(df)
  } else if (identical(type, "Produksjon")) {
    df <- parse_produksjon(df, total)
  } else {
    warning("Unimplemented file type. Returning unparsed data frame.")
  }

  df
}
